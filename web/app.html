<!doctype html>
<html lang="sv" data-theme="light">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>X-Matches â€“ Matcher</title>
<style>
  :root{
    /* Light (default) */
    --bg1:#b0ddff;          /* gradient top */
    --bg2:#e6f3ff;          /* gradient bottom */
    --card-bg:#ffffff;
    --ink:#0a2540;
    --muted:#4c5d73;
    --border:#b3d4ff;
    --primary:#1e66ff;
    --primary-700:#154ecc;
    --primary-ring: rgba(30,102,255,.25);
    --danger:#ff4d4f;
    --success-bg:#d1fadf;
    --success-fg:#065f46;
    --thead-grad-1:#f9fbff;
    --thead-grad-2:#f3f7ff;
    --row-hover:#f8fbff;
    --input-bg:#ffffff;
    --table-bg:#ffffff;
    --shadow:0 10px 30px rgba(2,12,27,.08);
  }

  /* Dark theme overrides */
  [data-theme="dark"]{
    --bg1:#0b1220;
    --bg2:#0e1729;
    --card-bg:#0f172a;
    --ink:#e2e8f0;
    --muted:#94a3b8;
    --border:#1e293b;
    --primary:#60a5fa;
    --primary-700:#3b82f6;
    --primary-ring: rgba(96,165,250,.25);
    --danger:#ef4444;
    --success-bg:#064e3b;
    --success-fg:#bbf7d0;
    --thead-grad-1:#0b1220;
    --thead-grad-2:#0e1729;
    --row-hover:#0b1220;
    --input-bg:#0b1220;
    --table-bg:#0b1220;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }

  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 60%);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    transition: background .25s ease, color .2s ease;
  }

  .container{ max-width:1100px; margin: clamp(1rem, 2vw, 2rem) auto; padding: 0 1rem; }
  .card{ background:var(--card-bg); border-radius:16px; box-shadow:var(--shadow); padding:1.25rem; margin-bottom:1rem; transition: background .25s ease, box-shadow .25s ease; }

  .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-bottom:.75rem; flex-wrap:wrap; }
  .filters{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; width:100%; }
  .filters input#q{ flex:1 1 260px; }
  @media (max-width: 760px){
    .filters{ flex-direction: column; align-items: stretch; }
    .seg{ align-self:flex-start; }
  }
  .chip{ display:inline-flex; align-items:center; gap:.4rem; padding:.3rem .6rem; border:1px solid var(--border); border-radius:999px; background:var(--table-bg); }
  .chip{ white-space: nowrap; }
  .filters .chip + .chip{ margin-left:.6rem; }
  .filter-which{ display:flex; flex-direction:column; gap:.3rem; }
  .filter-which .chip + .chip{ margin-left:0; }
  /* Make radio chips compact with a soft gradient */
  .filter-which .chip{
    padding:.2rem .5rem; border-radius:8px;
    background: linear-gradient(135deg, var(--sky-200), var(--sky-50));
    border-color: var(--border);
  }
  [data-theme="dark"] .filter-which .chip{
    background: linear-gradient(135deg, #0e1729, #0b1220);
  }
  .filter-which .chip.active{
    background: linear-gradient(135deg, var(--primary), var(--primary-700));
    color:#fff; border-color: transparent;
  }
  .filter-which input[type="radio"]{ margin-right:.35rem; }
  .seg{ display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden; background: var(--table-bg); }
  .seg button{ background:transparent; padding:.4rem .7rem; border:0; color: var(--ink); }
  .seg button.active{ background: var(--primary); color:#fff; font-weight:600; }
  h1{ margin:0; letter-spacing:.2px; }
  .sub{ color:var(--muted); margin:.25rem 0 0; }

  /* Inputs */
  label{ display:block; margin:.35rem 0 .2rem; font-size:.92rem; color:var(--muted); }
  input, select, textarea{
    width:100%; padding:.6rem .7rem; box-sizing:border-box;
    background:var(--input-bg); color:var(--ink);
    border:2px solid var(--border); border-radius:10px;
    transition:border-color .2s ease, box-shadow .2s ease, transform .06s ease, background .2s;
  }
  input:focus-visible, select:focus-visible, textarea:focus-visible{
    outline:none;
    border-color:var(--primary);
    box-shadow:0 0 0 4px var(--primary-ring);
  }
  /* Do not apply text-input styles to radios/checkboxes */
  input[type="radio"], input[type="checkbox"]{
    width:auto; padding:0; border:0; border-radius:4px; box-shadow:none; background:transparent;
  }
  input[type="radio"]:focus-visible, input[type="checkbox"]:focus-visible{ box-shadow:none; outline: none; }

  /* Buttons */
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    gap:.5rem; padding:.55rem .9rem; border-radius:12px;
    font-weight:600; border:0; cursor:pointer;
    transition: transform .05s ease, box-shadow .2s ease, background .2s ease, border-color .2s;
    user-select:none;
  }
  .btn:active{ transform: translateY(1px); }
  .btn-primary{
    background:var(--primary); color:#fff; box-shadow:0 8px 20px rgba(30,102,255,.28);
  }
  [data-theme="dark"] .btn-primary{ box-shadow: none; }
  .btn-primary:hover{ background:var(--primary-700); }
  .btn-outline{
    background:transparent; color:var(--primary); border:2px solid var(--primary);
  }
  .btn-outline:hover{ background:rgba(0,0,0,.03); }
  [data-theme="dark"] .btn-outline:hover{ background:rgba(255,255,255,.04); }
  .btn-danger{ background:var(--danger); color:#fff; }
  .actions{ display:flex; gap:.5rem; flex-wrap:wrap; }

  /* Layout */
  .row{ display:grid; grid-template-columns: repeat(3, 1fr); gap:.8rem; }
  .row-2{ display:grid; grid-template-columns: repeat(2, 1fr); gap:.8rem; }
  @media (max-width: 760px){
    .row, .row-2{ grid-template-columns: 1fr; }
  }

  /* Table */
  table{ border-collapse:separate; border-spacing:0; width:100%; background:var(--table-bg); border-radius:12px; overflow:hidden; }
  thead th{
    text-align:left; font-weight:700; font-size:.9rem; color:var(--muted);
    background: linear-gradient(var(--thead-grad-1), var(--thead-grad-2));
    position:sticky; top:0; z-index:1;
  }
  th, td{ padding:.65rem .7rem; border-bottom:1px solid #e7eefc; }
  [data-theme="dark"] th, [data-theme="dark"] td{ border-bottom:1px solid var(--border); }
  tbody tr:hover td{ background:var(--row-hover); }
  .badge{
    display:inline-block; padding:.2rem .55rem; border-radius:999px; font-size:.8rem;
    background:#eef; color:#1e40af;
  }
  .played{ background:var(--success-bg); color:var(--success-fg); }
  /* Toast */
  #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; z-index:9999; }
  .toast{ background:var(--card-bg); color:var(--ink); border:1px solid var(--border); padding:.6rem .9rem; border-radius:10px; box-shadow:var(--shadow); opacity:0; transition: opacity .2s, transform .2s; transform: translateY(6px); }
  .toast.show{ opacity:1; transform: translateY(0); }

  @media (prefers-reduced-motion: reduce){
    *, *::before, *::after{ transition:none !important; animation:none !important; }
  }
</style>

<div class="container">
  <div class="card">
    <div class="toolbar">
      <div>
        <h1>Matcher</h1>
        <p class="sub">LÃ¤gg till match och hÃ¥ll koll pÃ¥ resultat. âœ¨</p>
      </div>

      <!-- Verktyg -->
      <div class="filters">
        <input id="q" placeholder="SÃ¶k (lag, motstÃ¥nd, plats)" style="min-width:240px" />
        <div class="seg" role="tablist" aria-label="Vy">
          <button id="view_table" class="active" aria-selected="true">Tabell</button>
          <button id="view_cards" aria-selected="false">Kort</button>
        </div>
        <a class="btn btn-outline" href="/api/matches.csv" download>Exportera CSV</a>
        <a class="btn btn-outline" href="/api/matches.ics" download>Exportera iCal</a>
        <input id="importFile" type="file" accept=".csv,.xlsx" style="display:none" />
        <button id="importBtn" class="btn btn-outline">Importera</button>
        <button id="deleteAllBtn" class="btn btn-danger">Radera alla</button>
        <button id="themeToggle" class="btn btn-outline" aria-pressed="false" title="Byt tema">ðŸŒž Ljust</button>
        <div class="filter-which" role="group" aria-label="Visa">
          <label class="chip"><input type="radio" name="flt_which" id="flt_played_radio" value="played"/> Spelade</label>
          <label class="chip"><input type="radio" name="flt_which" id="flt_upcoming_radio" value="upcoming"/> Kommande</label>
        </div>
      </div>
    </div>

    <form id="createForm" style="margin-top:.25rem">
      <div class="row">
        <div>
          <label for="date">Datum</label>
          <input id="date" type="date" required />
        </div>
        <div>
          <label for="time">Starttid</label>
          <input id="time" type="time" required />
        </div>
        <div>
          <label for="end_time">Sluttid (valfritt)</label>
          <input id="end_time" type="time" />
        </div>
      </div>

      <div class="row-2">
        <div>
          <label for="team">VÃ¥rt lag</label>
          <input id="team" type="text" placeholder="Ex: IFK X F11" />
        </div>
        <div>
          <label for="opponent">MotstÃ¥ndare</label>
          <input id="opponent" type="text" />
        </div>
      </div>

      <div class="row-2">
        <div>
          <label for="venue">Hall/Plats</label>
          <input id="venue" type="text" placeholder="Ex: EslÃ¶vshallen" />
        </div>
        <div>
          <label for="city">Stad</label>
          <input id="city" type="text" placeholder="Ex: EslÃ¶v" />
        </div>
      </div>

      <div class="row-2">
        <div>
          <label for="league">Serie (valfritt)</label>
          <input id="league" type="text" />
        </div>
        <div>
          <label for="court">Plan (valfritt)</label>
          <input id="court" type="text" />
        </div>
      </div>

      

      <div class="row-2">
        <div>
          <label for="top_scorer_team">BÃ¤sta mÃ¥lskytt â€“ vÃ¥rt lag</label>
          <input id="top_scorer_team" type="text" placeholder="Ex: A. Svensson (3)" />
        </div>
        <div>
          <label for="top_scorer_opponent">BÃ¤sta mÃ¥lskytt â€“ motstÃ¥nd</label>
          <input id="top_scorer_opponent" type="text" placeholder="Ex: K. Karlsson (2)" />
        </div>
      </div>

      <label for="notes">Noteringar</label>
      <textarea id="notes" rows="2" placeholder="Ã–vrigt..."></textarea>

      <div style="margin-top:.9rem">
        <button class="btn btn-primary" type="submit">Spara match</button>
      </div>
    </form>
  </div>

  <div class="card" id="tableWrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>Datum</th><th>Tid</th><th>Lag</th><th>MotstÃ¥ndare</th>
          <th>Plats</th><th>Resultat</th><th>Toppskyttar</th><th>Spelad</th><th>Ã…tgÃ¤rder</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="card" id="cardsWrap" style="display:none">
    <div id="cards"></div>
  </div>
  <div id="toast"></div>
  <div class="card" style="display:flex; gap:.5rem; align-items:center; justify-content:space-between">
    <div id="me"></div>
    <div>
      <a id="adminBtn" href="/admin" class="btn btn-outline" style="display:none; margin-right:.4rem">Admin</a>
      <button id="logoutBtn" class="btn btn-outline">Logga ut</button>
    </div>
  </div>
</div>

<script>
  // --- Tema-hantering ---
  const THEME_KEY = 'xmatches_theme';

  function getPreferredTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    if (saved === 'dark' || saved === 'light') return saved;
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
      ? 'dark' : 'light';
  }
  function applyTheme(theme){
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
    const btn = document.getElementById('themeToggle');
    if (btn){
      const isDark = theme === 'dark';
      btn.setAttribute('aria-pressed', String(isDark));
      btn.textContent = isDark ? 'ðŸŒ™ MÃ¶rkt' : 'ðŸŒž Ljust';
    }
  }
  // Init
  applyTheme(getPreferredTheme());
  // Toggle
  document.getElementById('themeToggle').addEventListener('click', () => {
    const next = (document.documentElement.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
    applyTheme(next);
  });

  // --- App-logik ---
  const STATE_KEY='xmatches_ui_state_v1';
  function loadState(){
    try{ return JSON.parse(localStorage.getItem(STATE_KEY)||'{}') }catch{ return {} }
  }
  function saveState(s){ localStorage.setItem(STATE_KEY, JSON.stringify(s)) }

  async function list() {
    const res = await fetch('/api/matches');
    const data = await res.json();
    // migrate old state (upcoming/played) to new 'which' radio
    const prev = loadState();
    if (!prev.which) {
      if (prev && prev.played && !prev.upcoming) prev.which = 'played'; else prev.which = 'upcoming';
      saveState(prev);
    }
    const state = Object.assign({ q:'', which:'upcoming', view:'table' }, loadState());
    document.getElementById('q').value = state.q;
    const up = document.getElementById('flt_upcoming_radio');
    const pl = document.getElementById('flt_played_radio');
    up.checked = state.which === 'upcoming';
    pl.checked = state.which === 'played';
    // visual active state for chips
    up.closest('label').classList.toggle('active', up.checked);
    pl.closest('label').classList.toggle('active', pl.checked);
    document.getElementById('view_table').classList.toggle('active', state.view==='table');
    document.getElementById('view_cards').classList.toggle('active', state.view==='cards');

    // Filter
    const now = new Date();
    const norm = s=> (s||'').toLowerCase();
    const filtered = data.filter(m => {
      const text = [m.team,m.opponent,m.home_team,m.away_team,m.venue,m.city,m.notes].map(norm).join(' ');
      if (state.q && !text.includes(state.q.toLowerCase())) return false;
      const d = m.start_iso ? new Date(m.start_iso) : (m.date_raw ? new Date(m.date_raw) : null);
      const isUpcoming = d ? d >= new Date(now.toDateString()) : true;
      if (state.which === 'upcoming' && !isUpcoming) return false;
      if (state.which === 'played' && !m.played) return false;
      return true;
    });

    // Sort by date asc
    filtered.sort((a,b)=>{
      const da = a.start_iso ? new Date(a.start_iso) : (a.date_raw ? new Date(a.date_raw) : new Date(0));
      const db = b.start_iso ? new Date(b.start_iso) : (b.date_raw ? new Date(b.date_raw) : new Date(0));
      return da-db || a.id-b.id;
    });

    // Render table
    const tb = document.querySelector('#tbl tbody');
    tb.innerHTML = '';
    filtered.forEach(m => {
      const d = m.start_iso ? new Date(m.start_iso) : (m.date_raw ? new Date(m.date_raw) : null);
      const dateStr = d ? d.toLocaleDateString('sv-SE') : (m.date_raw||'');
      const timeStr = d ? d.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit'}) : (m.time_raw||'');
      const tr = document.createElement('tr');
      
      tr.innerHTML = `
        <td>${dateStr}</td>
        <td>${timeStr}</td>
        <td>${m.home_team||m.team||''}</td>
        <td>${m.away_team||m.opponent||''}</td>
        <td>${[m.venue,m.city].filter(Boolean).join(', ')}</td>
        <td>${(m.goals_for??'')!=='' || (m.goals_against??'')!=='' ? `${m.goals_for||''}â€“${m.goals_against||''}` : ''}</td>
        <td>${[m.top_scorer_team,m.top_scorer_opponent].filter(Boolean).join(' | ')}</td>
        <td>${m.played?'<span class="badge played">Spelad</span>':''}</td>
        <td class="actions">
          <button class="btn btn-outline editBtn" data-id="${m.id}">Ã„ndra</button>
          <button class="btn btn-outline scoreBtn" data-id="${m.id}">Resultat</button>
          <button class="btn btn-danger delBtn" data-id="${m.id}">Radera</button>
          <button class="btn btn-outline topscorerBtn" data-id="${m.id}">Toppskytt</button>
        </td>`;

      tb.appendChild(tr);
    });

    // Cards render
    const cardsEl = document.getElementById('cards');
    cardsEl.innerHTML = '';
    filtered.forEach(m => {
      const d = m.start_iso ? new Date(m.start_iso) : (m.date_raw ? new Date(m.date_raw) : null);
      const dateStr = d ? d.toLocaleDateString('sv-SE') : (m.date_raw||'');
      const timeStr = d ? d.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit'}) : (m.time_raw||'');
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div>
            <div style="font-size:.95rem; color:var(--muted)">${dateStr} ${timeStr}</div>
            <div style="font-size:1.1rem; font-weight:700">${m.home_team||m.team||''} â€“ ${m.away_team||m.opponent||''}</div>
            <div style="color:var(--muted)">${[m.venue,m.city].filter(Boolean).join(', ')}</div>
          </div>
          <div>${(m.goals_for??'')!=='' || (m.goals_against??'')!=='' ? `<span class="badge">${m.goals_for||''}â€“${m.goals_against||''}</span>` : ''}</div>
        </div>
        <div class="actions" style="margin-top:.6rem">
          <button class="btn btn-outline editBtn" data-id="${m.id}">Ã„ndra</button>
          <button class="btn btn-outline scoreBtn" data-id="${m.id}">Resultat</button>
          <button class="btn btn-danger delBtn" data-id="${m.id}">Radera</button>
        </div>`;
      cardsEl.appendChild(card);
    });

    // Bind edit/delete actions
    document.querySelectorAll('.delBtn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('Radera denna match?')) return;
        await fetch(`/api/matches/${id}`, { method:'DELETE' });
        toast('Raderade match');
        list();
      });
    });

    document.querySelectorAll('.editBtn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        const res = await fetch(`/api/matches/${id}`);
        const m = await res.json();
        document.querySelector('#date').value = (m.start_iso ? new Date(m.start_iso).toISOString().slice(0,10) : (m.date_raw||''));
        document.querySelector('#time').value = (m.start_iso ? new Date(m.start_iso).toISOString().slice(11,16) : (m.time_raw||''));
        document.querySelector('#end_time').value = m.end_time_raw||'';
        document.querySelector('#team').value = m.team||'';
        document.querySelector('#opponent').value = m.opponent||'';
        document.querySelector('#venue').value = m.venue||'';
        document.querySelector('#city').value = m.city||'';
        document.querySelector('#league').value = m.league||'';
        document.querySelector('#court').value = m.court||'';
        document.querySelector('#notes').value = m.notes||'';
        document.querySelector('#top_scorer_team').value = m.top_scorer_team||'';
        document.querySelector('#top_scorer_opponent').value = m.top_scorer_opponent||'';
        // Save update
        const ok = confirm('Spara Ã¤ndringar?');
        if (!ok) return;
        const body = {
          date_raw: document.querySelector('#date').value,
          time_raw: document.querySelector('#time').value,
          end_time_raw: document.querySelector('#end_time').value,
          team: document.querySelector('#team').value,
          opponent: document.querySelector('#opponent').value,
          venue: document.querySelector('#venue').value,
          city: document.querySelector('#city').value,
          league: document.querySelector('#league').value,
          court: document.querySelector('#court').value,
          notes: document.querySelector('#notes').value,
          top_scorer_team: document.querySelector('#top_scorer_team').value,
          top_scorer_opponent: document.querySelector('#top_scorer_opponent').value
        };
        await fetch(`/api/matches/${id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        toast('Uppdaterade match');
        list();
      });
    });

    document.querySelectorAll('.topscorerBtn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        const team = prompt('Toppskytt â€“ vÃ¥rt lag', '');
        if (team === null) return; // cancelled
        const opp = prompt('Toppskytt â€“ motstÃ¥nd', '');
        if (opp === null) return; // cancelled
        await fetch(`/api/matches/${id}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ top_scorer_team: team, top_scorer_opponent: opp })
        });
        toast('Uppdaterade toppskyttar');
        list();
      });
    });
  }

  document.querySelector('#createForm').addEventListener('submit', async (e) => {
    e.preventDefault();
      const body = {
        date_raw: document.querySelector('#date').value,
        time_raw: document.querySelector('#time').value,
        end_time_raw: document.querySelector('#end_time').value,
        team: document.querySelector('#team').value,
        opponent: document.querySelector('#opponent').value,
        venue: document.querySelector('#venue').value,
        city: document.querySelector('#city').value,
        league: document.querySelector('#league').value,
        court: document.querySelector('#court').value,
        notes: document.querySelector('#notes').value,
        top_scorer_team: document.querySelector('#top_scorer_team').value,
        top_scorer_opponent: document.querySelector('#top_scorer_opponent').value
      };
    await fetch('/api/matches', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    toast('Skapade match');
    e.target.reset();
    list();
  });

  // UI wiring for filters & view
  function bindUI(){
    const state = Object.assign({ q:'', upcoming:true, played:true, view:'table' }, loadState());
    const save = ()=>{ saveState(state); list(); };
    document.getElementById('q').addEventListener('input', (e)=>{ state.q = e.target.value; save(); });
    document.getElementById('flt_upcoming_radio').addEventListener('change', (e)=>{ if (e.target.checked) { state.which = 'upcoming'; e.target.closest('label').classList.add('active'); document.getElementById('flt_played_radio').closest('label').classList.remove('active'); save(); } });
    document.getElementById('flt_played_radio').addEventListener('change', (e)=>{ if (e.target.checked) { state.which = 'played'; e.target.closest('label').classList.add('active'); document.getElementById('flt_upcoming_radio').closest('label').classList.remove('active'); save(); } });
    document.getElementById('view_table').addEventListener('click', ()=>{ state.view='table'; save(); toggleView(); });
    document.getElementById('view_cards').addEventListener('click', ()=>{ state.view='cards'; save(); toggleView(); });
    document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const fd = new FormData(); fd.append('file', f);
      const res = await fetch('/api/matches/import', { method:'POST', body: fd });
      if (!res.ok){ toast('Import misslyckades'); return; }
      const j = await res.json();
      toast(`Importerade ${j.imported}, misslyckades ${j.failed}`);
      list();
      e.target.value = '';
    });
    document.getElementById('deleteAllBtn').addEventListener('click', async ()=>{
      if (!confirm('Radera ALLA matcher?')) return;
      if (!confirm('Ã„r du sÃ¤ker? Detta gÃ¥r inte att Ã¥ngra.')) return;
      const res = await fetch('/api/matches', { method:'DELETE' });
      if (!res.ok){ toast('Radering misslyckades'); return; }
      const j = await res.json().catch(()=>({deleted:0}));
      toast(`Raderade ${j.deleted||0} matcher`);
      list();
    });
    toggleView();
  }
  function toggleView(){
    const state = Object.assign({ view:'table' }, loadState());
    document.getElementById('view_table').classList.toggle('active', state.view==='table');
    document.getElementById('view_cards').classList.toggle('active', state.view==='cards');
    document.getElementById('tableWrap').style.display = state.view==='table' ? '' : 'none';
    document.getElementById('cardsWrap').style.display = state.view==='cards' ? '' : 'none';
  }

  bindUI();
  list();

  // show current user and enable logout
  (async ()=>{
    try {
      const res = await fetch('/api/auth/me');
      if (res.ok) {
        const me = await res.json();
        document.getElementById('me').textContent = `Inloggad som ${me.email}`;
        if (me.is_admin) { document.getElementById('adminBtn').style.display = 'inline-flex'; }
      }
    } catch {}
  })();

  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    await fetch('/api/auth/logout', { method:'POST' });
    window.location = '/login';
  });

  function toast(msg){
    const host = document.getElementById('toast');
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = msg;
    host.appendChild(el);
    requestAnimationFrame(()=> el.classList.add('show'));
    setTimeout(()=>{
      el.classList.remove('show');
      setTimeout(()=> host.removeChild(el), 200);
    }, 2200);
  }
</script>
</html>
